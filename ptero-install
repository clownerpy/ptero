#!/usr/bin/env bash
set -e

# =========================
# Colors & Spinner function
# =========================
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
CYAN="\e[36m"
RESET="\e[0m"

spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 $pid 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  printf "      \b\b\b\b\b\b"
}

run_quiet() {
  "$@" &> /dev/null &
  spinner $!
}

# =========================
# Banner Animation
# =========================
banner() {
clear
echo -e "${CYAN}"
echo "  ____            _             _     _           _    "
echo " |  _ \ ___  __ _| |_ ___  __ _| |__ (_)_ __ ___ | |_  "
echo " | |_) / _ \/ _\` | __/ _ \/ _\` | '_ \| | '_ \` _ \| __| "
echo " |  __/  __/ (_| | ||  __/ (_| | |_) | | | | | | | |_  "
echo " |_|   \___|\__,_|\__\___|\__,_|_.__/|_|_| |_| |_|\__| "
echo -e "${YELLOW}"
echo "                 Made By DracoHost"
echo -e "${RESET}"
sleep 2
clear
}

# =========================
# Install Dependencies
# =========================
install_dependencies() {
  echo -e "${GREEN}Updating system and installing dependencies...${RESET}"
  run_quiet apt update && run_quiet apt upgrade -y
  run_quiet apt install -y software-properties-common curl apt-transport-https ca-certificates gnupg lsb-release unzip git redis-server mariadb-server nginx
  add-apt-repository ppa:ondrej/php -y
  run_quiet apt update
  run_quiet apt install -y php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-zip php8.2-gd php8.2-mbstring php8.2-curl php8.2-xml php8.2-bcmath composer
}

# =========================
# Install Pterodactyl Panel
# =========================
install_panel() {
  echo -e "${GREEN}Downloading official Pterodactyl Panel installer...${RESET}"
  run_quiet mkdir -p /var/www/pterodactyl
  cd /var/www/pterodactyl
  run_quiet git clone https://github.com/pterodactyl/panel.git .
  run_quiet cp .env.example .env
  echo -e "${GREEN}Installing Composer dependencies...${RESET}"
  run_quiet composer install --no-dev --optimize-autoloader
  echo -e "${GREEN}Setting permissions...${RESET}"
  run_quiet chown -R www-data:www-data /var/www/pterodactyl
  run_quiet chmod -R 755 /var/www/pterodactyl
  echo -e "${YELLOW}âœ… Basic Panel files installed.${RESET}"
  echo -e "${CYAN}Next, run the official Pterodactyl artisan setup manually:${RESET}"
  echo -e "cd /var/www/pterodactyl && php artisan key:generate --force"
  echo -e "php artisan p:environment:setup"
  echo -e "php artisan p:install"
  echo -e "${YELLOW}Follow prompts to configure database, admin user, and webserver.${RESET}"
}

# =========================
# Main Script
# =========================
banner
install_dependencies
install_panel
